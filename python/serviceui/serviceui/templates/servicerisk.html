{% extends 'base.html' %}
{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/jquery.ui.treemap.js') }}"></script>
<script>
  var riskdata = [
  {% for r in results.risks %}
    {{ r|tojson|safe }},
  {% endfor %}
  ];

  // Process riskdata and return object suitable for treemap
  function maketreedata() {
    var treedata = {id: "root", children: []};

    var totalimpact = 0.0;
    for (i = 0; i < riskdata.length; i++) {
      // If noted risk is unknown, just ignore the entry
      if (riskdata[i].risk.worst_case == 0) {
        continue;
      }
      totalimpact += riskdata[i].risk.highest_business_impact;
    }

    for (i = 0; i < riskdata.length; i++) {
      // If noted risk is unknown, just ignore the entry
      if (riskdata[i].risk.worst_case == 0) {
        continue;
      }
      var nv = {
        id: riskdata[i].rra.name,
        size: [riskdata[i].risk.highest_business_impact / totalimpact],
        color: [riskdata[i].risk.median / 16,
          riskdata[i].risk.worst_case / 16]
      }
      treedata["children"].push(nv);
    }
    return treedata;
  }

  $.fn.dataTable.ext.type.detect.unshift(function (d) {
    var b = $(d).text();
    if (b == 'confidential secret' || b == 'confidential restricted' ||
      b == 'confidential internal' || b == 'public' || b == 'unknown') {
      return "dc";
    } else if (b == 'maximum' || b == 'high' || b == 'medium' || b == 'low'
      || b == 'unknown') {
      return "impact";
    }
  });

  $.fn.dataTable.ext.type.order['impact-pre'] = function (d) {
    var lbl = $(d).text();
    switch (lbl) {
      case "maximum": return 4;
      case "high": return 3;
      case "medium": return 2;
      case "low": return 1;
    }
    return 0;
  }

  $.fn.dataTable.ext.type.order['dc-pre'] = function (d) {
    var lbl = $(d).text();
    switch (lbl) {
      case "confidential secret": return 4;
      case "confidential restricted": return 3;
      case "confidential internal": return 2;
      case "public": return 1;
    }
    return 0;
  }

  function populateDetailsScenarios(riskel) {
    $('#detscenarios tbody').empty();
    var d = {'RRA': {}, 'Observatory': {}, 'Compliance': {}, 'Vulnerability': {}};
    var validscenarios = 0;
    for (i = 0; i < riskel.scenarios.length; i++) {
      var lk = '';
      var ak = '';

      if (!riskel.scenarios[i].nodata) {
        validscenarios++;
      }

      if (riskel.scenarios[i].name.includes('RRA')) {
        lk = 'RRA';
      } else if (riskel.scenarios[i].name.includes('Compliance')) {
        lk = 'Compliance';
      } else if (riskel.scenarios[i].name.includes('Vulnerability')) {
        lk = 'Vulnerability';
      } else if (riskel.scenarios[i].name.includes('httpobs')) {
        lk = 'Observatory';
      } else {
        continue;
      }

      if (riskel.scenarios[i].name.includes('reputation')) {
        ak = 'Reputation';
      } else if (riskel.scenarios[i].name.includes('financial')) {
        ak = 'Financial';
      } else if (riskel.scenarios[i].name.includes('productivity')) {
        ak = 'Productivity';
      } else {
        continue;
      }

      var rv = [];

      switch(riskel.scenarios[i].impact) {
        case 0:
          rv.push('unknown');
          break;
        case 1:
          rv.push('low');
          break;
        case 2:
          rv.push('medium');
          break;
        case 3:
          rv.push('high');
          break;
        case 4:
          rv.push('maximum');
          break;
      }
      rv.push(Number((riskel.scenarios[i].impact).toFixed(2)));

      var prob = riskel.scenarios[i].probability;
      if (prob >= 3.0) {
        rv.push('high');
      } else if (prob >= 2.0) {
        rv.push('medium');
      } else if (prob >= 1.0) {
        rv.push('low');
      } else {
        rv.push('unknown');
      }
      rv.push(Number((riskel.scenarios[i].probability).toFixed(2)));

      var score = riskel.scenarios[i].score;
      if (score >= 13.0) {
        rv.push('maximum');
      } else if (score >= 9.0) {
        rv.push('high');
      } else if (score >= 5.0) {
        rv.push('medium');
      } else if (score > 0) {
        rv.push('low');
      } else {
        rv.push('unknown');
      }
      rv.push(Number((riskel.scenarios[i].score).toFixed(2)));

      d[lk][ak] = rv;
    }
    for (var kv in d) {
      for (var kv2 in d[kv]) {
        nr = $('<tr></tr>');
        nr.append('<td>' + kv + '</td>');
        nr.append('<td>' + kv2 + '</td>');
        nr.append('<td><span name="rlabel">' + d[kv][kv2][0] + '</span> (' + d[kv][kv2][1] + ')</td>');
        nr.append('<td><span name="rlabel">' + d[kv][kv2][2] + '</span> (' + d[kv][kv2][3] + ')</td>');
        nr.append('<td><span name="rlabel">' + d[kv][kv2][4] + '</span> (' + d[kv][kv2][5] + ')</td>');
        $('#detscenarios tbody').append(nr);
      }
    }

    nr = $('<tr></tr>')
    nr.append('<td colspan=4>Considered scenarios</td><td>' + validscenarios + '</td>')
    $('#detscenarios tbody').append(nr);

    nr = $('<tr></tr>')
    nr.append('<td colspan=4>Median scenario risk</td><td><span name="rlabel">'
      + riskel.risk.median_label + '</span> (' + Number((riskel.risk.median).toFixed(2)) + ')</td>')
    $('#detscenarios tbody').append(nr);

    nr = $('<tr></tr>')
    nr.append('<td colspan=4>Maximum scenario risk</td><td><span name="rlabel">'
      + riskel.risk.worst_case_label + '</span> (' + Number((riskel.risk.worst_case).toFixed(2)) + ')</td>')
    $('#detscenarios tbody').append(nr);
  };

  var mapClickHandler = function(e, data) {
    var n = data.nodes;
    var riskel = null;
    for (i = 0; i < riskdata.length; i++) {
      if (riskdata[i].rra.name == n[0].id) {
        riskel = riskdata[i];
        break;
      }
    }
    populateDetailsScenarios(riskel);
    trColor();
    $('#riskdetails').modal('show');
  };

  $(document).ready(function() {
    rt = $('#riskstable > tbody');
    for (i = 0; i < riskdata.length; i++) {
      var tr = '<tr>' +
        '<td>' + riskdata[i].rra.name + '</td>' +
        '<td><span name="rlabel">' + riskdata[i].rra.default_data_classification + '</span></td>' +
        '<td><span name="rlabel">' + riskdata[i].risk.highest_business_impact_label + '</span></td>' +
        '<td><span name="rlabel">' + riskdata[i].risk.median_label + '</span></td>' +
        '<td><span name="rlabel">' + riskdata[i].risk.worst_case_label + '</span></td>' +
        '</tr>';
      rt.append(tr);
    }

    $('#riskstable').DataTable({
      "createdRow": function(row, data, index) {
        trColor();
      },
      "pageLength": 50
    });

    $("#riskmap").treemap({
      "nodeData": maketreedata(),
      "dimensions": [$("#riskmap").width(), 600],
      "sizeOption": 0,
      "colorOption": 0,
      "labelsEnabled": true,
      "colorStops": [
        {"val":0, "color":"#eee"},
        {"val":1, "color":"#f00"},
      ]
    })
    .bind('treemapclick', mapClickHandler);

    $('#selectrisk option').click(function () {
      var t = $(this).text();
      if (t.indexOf('median') > -1) {
        $('#riskmap').treemap('option', 'colorOption', 0);
      } else {
        $('#riskmap').treemap('option', 'colorOption', 1);
      }
    });
  });
</script>
{% endblock %}
{% block content %}
<div class="container">
  <h3>Service risk view</h3>
  <p>
  Size reflects service business impact assessed from RRA. Cell color reflects
  analyzed real-time service risk.
  </p>
</div>
<div class="container" id="riskmap"></div>
<div class="container">
  <div class="col-md-4" style="margin-top: 10px; margin-bottom: 10px;">
    <select class="form-control" id="selectrisk" autocomplete="off">
      <option>Risk: median general case</option>
      <option>Risk: worst case</option>
    </select>
  </div>
</div>
<div class="container">
  <table id="riskstable" class="display" cellspacing="0" width="100%">
    <thead>
      <tr>
      <td>Service</td>
      <td>Data class</td>
      <td>Potential business impact</td>
      <td>Median risk</td>
      <td>Worst case</td>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>
<div id="riskdetails" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="model-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h3 id="riskdetailsLabel">Risk details</h3>
      </div>
      <div class="modal-body">
        <p>
        <h4>Scenarios</h4>
        </p>
        <p>
          <table id="detscenarios" class="suTable" cellspacing="0" width="100%">
            <thead><tr><td>Source</td><td>Attribute</td><td>Impact</td><td>Probability</td><td>Risk</td></tr></thead>
            <tbody>
            </tbody>
          </table>
        </p>
      </div>
      <div class="modal-footer">
         <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
