{% extends 'base.html' %}
{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/jquery.ui.treemap.js') }}"></script>
<script>
  var treedata = {"id": "root", "children": []};
  var rdata = [
  {% for r in results.risks %}
    {{ r|tojson|safe }},
  {% endfor %}
  ];
  function maketreedata() {
    var totalmedian = 0.0;
    for (i = 0; i < rdata.length; i++) {
      totalmedian += rdata[i].risk.median;
    }
    var totalsize = 0.0;
    for (i = 0; i < rdata.length; i++) {
      totalsize += rdata[i].risk.data_classification;
    }
    for (i = 0; i < rdata.length; i++) {
      var nv = {};
      nv["id"] = rdata[i].rra.name;
      var datacolor;
      switch(rdata[i].risk.data_classification) {
        case 0.0:
        case 1.0:
          datacolor = 0.1;
          break;
        case 2.0:
          datacolor = .25;
          break;
        case 3.0:
          datacolor = 0.5;
          break;
        case 4.0:
          datacolor = 0.9;
          break;
      }
      var riskcolor = rdata[i].risk.median / 16;
      nv["color"] = [datacolor, riskcolor];
      nv["size"] = [rdata[i].risk.median / totalmedian,
        rdata[i].risk.data_classification / totalsize];
      treedata["children"].push(nv);
    }
  }
  $(document).ready(function() {
    maketreedata();
    $('#servtab').DataTable( {
      "createdRow": function (row, data, index) {
        trColor();
      },
      "pageLength": 50
    });
    trColor();
    $("#riskmap").treemap({
      "nodeData": treedata,
      "dimensions": [$("#riskmap").width(), 600],
      "sizeOption": 0,
      "colorOption": 0,
      "colorStops": [
        {"val":0, "color":"#eee"},
        {"val":1, "color":"#f00"},
      ]
    });
    $("#m1").click(function() {
      $("#riskmap").treemap("option", "sizeOption", 0);
      $("#riskmap").treemap("option", "colorOption", 0);
    });
    $("#m2").click(function() {
      $("#riskmap").treemap("option", "sizeOption", 1);
      $("#riskmap").treemap("option", "colorOption", 1);
    });
  });
</script>
{% endblock %}
{% block content %}
<div class="container">
  <h3>Service risk view</h3>
</div>
<div class="container" id="riskmap"></div>
<div class="container">
  <button id="m1" type="button" class="btn btn-default btn-xs">Risk / data classification</button>
  <button id="m2" type="button" class="btn btn-default btn-xs">Data classification / risk</button>
</div>
<div class="container">
  <table id="servtab" class="display" cellspacing="0" width="100%">
    <thead>
      <tr>
      <td>Service</td>
      <td>Data class</td>
      <td>Median risk</td>
      <td>Worst case</td>
      </tr>
    </thead>
    <tbody>
      {% for r in results.risks %}
      <tr>
      <td>{{ r.rra.name }}</td>
      <td><span name="rlabel">{{ r.rra.default_data_classification }}</span></td>
      <td><span name="rlabel">{{ r.risk.median_label }}</span></td>
      <td><span name="rlabel">{{ r.risk.worst_case_label }}</span></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
